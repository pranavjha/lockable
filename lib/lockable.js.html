<!DOCTYPE html>
<html>
<head>
    <title>lockable</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport"
        content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    
    <link rel="stylesheet"
        media="all"
        href="../assets/file_1.css"/>
    
    <link rel="stylesheet"
        media="all"
        href="../assets/file_5.css"/>
    
    <link rel="stylesheet"
        media="all"
        href="../assets/32px.png"/>
    
    <link rel="stylesheet"
        media="all"
        href="../assets/40px.png"/>
    
    <link rel="stylesheet"
        media="all"
        href="../assets/throbber.gif"/>
    
    <link rel="stylesheet"
        media="all"
        href="../assets/file_7.css"/>
    
    <link rel="stylesheet"
        media="all"
        href="../assets/file_8.css"/>
    

    
    <script src="../assets/file_2.js"
        type="text/javascript"></script>
    
    <script src="../assets/file_3.js"
        type="text/javascript"></script>
    
    <script src="../assets/file_4.js"
        type="text/javascript"></script>
    
    <script src="../assets/file_6.js"
        type="text/javascript"></script>
    

    <script type="application/json" id="jsTreeJSON">
        [{"id":"lib","text":"lib","icon":"jstree-folder","parent":"#","a_attr":{"href":"."},"state":{"opened":true}},{"id":"lib/lockable.js","text":"lockable.js","icon":"jstree-file","parent":"lib","a_attr":{"href":"lockable.js.html"},"state":{"selected":true}},{"id":"test","text":"test","icon":"jstree-folder","parent":"#","a_attr":{"href":"../test"},"state":{"opened":false}},{"id":"test/acquire.js","text":"acquire.js","icon":"jstree-file","parent":"test","a_attr":{"href":"../test/acquire.js.html"},"state":{"selected":false}},{"id":"test/queue.js","text":"queue.js","icon":"jstree-file","parent":"test","a_attr":{"href":"../test/queue.js.html"},"state":{"selected":false}},{"id":"test/sequence.js","text":"sequence.js","icon":"jstree-file","parent":"test","a_attr":{"href":"../test/sequence.js.html"},"state":{"selected":false}},{"id":"Gruntfile.js","text":"Gruntfile.js","icon":"jstree-file","parent":"#","a_attr":{"href":"../Gruntfile.js.html"},"state":{"selected":false}},{"id":"README.md","text":"README.md","icon":"jstree-file","parent":"#","a_attr":{"href":"../README.md.html"},"state":{"selected":false}}]
    </script>
</head>
<body class="markdown-body">
<h1>
    lockable
</h1>
<div class="subHeading">
    lib/lockable.js
</div>
<button type="button" class="navigatorToggle">&#9776; files...</button>
<nav class="navigationTree minimized">
    <input type="text" id="jsTreeSearch" placeholder="search..."/>
    <div></div>
</nav>
<section>
    <ul class="sectionDetails ">
        
        
        <li id="section-1">
            <div class="annotation">
                <h2 id="monitor">monitor</h2>
<p> utility for promises</p>

            </div><div class="content">
                <div class="highlight"><pre><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>);</pre></div>
            </div>
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
                <p> holds data for concurrency checks</p>

            </div><div class="content">
                <div class="highlight"><pre><span class="hljs-keyword">var</span> locks = {
    concurrency: <span class="hljs-number">1</span>,
    children: {}
};
<span class="hljs-keyword">var</span> idGen = <span class="hljs-number">0</span>;

<span class="hljs-built_in">module</span>.exports = {</pre></div>
            </div>
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
                <p> Acquire function is used to acquire a lock on a keychain</p>
<p> A keychain is represents a lock and is a <code>.</code> separated string. A keychain string <code>&#39;A.B.C&#39;</code> will represent a
 hierarchy with parents <code>&#39;A&#39;</code> and <code>&#39;A.B&#39;&#39;</code>.</p>
<p> Acquiring a lock on any parent keychain will invalidate all the child keychain locks. This is detailed in the
 below examples:</p>
<pre><code> <span class="hljs-string">``</span><span class="hljs-string">`javascript</span>
</code></pre><p> var lockable = require(‘lockable’);</p>
<p> var key1 = lockable.acquire(‘A.B’);</p>
<p> key1() //  returns true here</p>
<p> var key2 = lockable.acquire(‘A.B’);</p>
<p> key1() //  returns false
 key2() //  returns true</p>
<p> var key3 = lockable.acquire(‘A’);</p>
<p> key1() //  returns false
 key2() //  returns false
 key3() //  returns true</p>
<p> var key4 = lockable.acquire(‘A.B’);</p>
<p> key1() //  returns false
 key2() //  returns false
 key3() //  returns true
 key4() //  returns true
 ```</p>

            </div><div class="content">
                <div class="highlight"><pre>    acquire: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">lockId</span>) </span>{
        <span class="hljs-keyword">var</span> thisLock = locks;
        <span class="hljs-keyword">var</span> lockSequence = lockId.split(<span class="hljs-string">'.'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, j = lockSequence.length; i &lt; j; i = i + <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">if</span> (!thisLock.children[lockSequence[i]]) {
                thisLock.children[lockSequence[i]] = {
                    concurrency: <span class="hljs-number">1</span>,
                    children: {}
                };
            }
            thisLock = thisLock.children[lockSequence[i]];
        }
        thisLock.concurrency = thisLock.concurrency + <span class="hljs-number">1</span>;
        thisLock.children = {};
        <span class="hljs-keyword">var</span> concurrency = thisLock.concurrency;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> thisLock = locks;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, j = lockSequence.length; i &lt; j; i = i + <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">if</span> (!thisLock.children[lockSequence[i]]) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                thisLock = thisLock.children[lockSequence[i]];
            }
            <span class="hljs-keyword">return</span> (thisLock.concurrency === concurrency);
        };
    },</pre></div>
            </div>
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
                <p> Sequence is used to <em>sequencify</em> the resolution of promises. Promises added in a sequence will be resolved in the
 same sequence in which they are added, irrespective of the execution time. Even though the actual promise will be
 executed instantaneously, the callback will wait for the previous promises to resolve. This is illustrated in the
 below examples</p>
<pre><code> <span class="hljs-string">``</span><span class="hljs-string">`javascript</span>
</code></pre><p> var sequence = lockable.sequence();
 var promise1 = Promise.delay(50);
 var promise2 = Promise.delay(60);
 var promise3 = Promise.delay(30);</p>
<p> sequence(promise1).then(function() {
     console.log(1);
 });</p>
<p> sequence(promise2).then(function() {
     console.log(2);
 });</p>
<p> sequence(promise3).then(function() {
     console.log(3);
 });</p>
<p> // Output:
 // 1 (after 50 ms from start)
 // 2 (after 60 ms form start)
 // 3 (after 60 ms form start)</p>
<p> ```</p>

            </div><div class="content">
                <div class="highlight"><pre>    sequence: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sequenceId, startCb, endCb</span>) </span>{
        <span class="hljs-keyword">if</span> (!sequenceId) {
            sequenceId = <span class="hljs-string">'sequence_'</span> + idGen;
            idGen = idGen + <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">var</span> promiseSequence = [];
        <span class="hljs-keyword">var</span> keyChain = <span class="hljs-keyword">this</span>.acquire(sequenceId);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">promise</span>) </span>{
            promise = promise || <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span> (!promiseSequence.length &amp;&amp; startCb) {</pre></div>
            </div>
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
                <p> when the sequence starts, we call the start callback</p>

            </div><div class="content">
                <div class="highlight"><pre>                startCb();
            }
            promiseSequence.unshift(promise);

            <span class="hljs-keyword">var</span> lengthThen = promiseSequence.length;
            <span class="hljs-keyword">var</span> endSequenceIfRequired = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (lengthThen === promiseSequence.length) {</pre></div>
            </div>
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
                <p> when nothing new got added in the sequence, we end the sequence</p>

            </div><div class="content">
                <div class="highlight"><pre>                    <span class="hljs-keyword">if</span> (endCb) {
                        endCb();
                    }</pre></div>
            </div>
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
                <p> clear off the queue</p>

            </div><div class="content">
                <div class="highlight"><pre>                    promiseSequence = [];
                }
            };
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all(promiseSequence).spread(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">thisValue</span>) </span>{
                endSequenceIfRequired();
                <span class="hljs-keyword">if</span> (!keyChain()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'concurrency failure'</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> thisValue;
                }
            }).catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                endSequenceIfRequired();
                <span class="hljs-keyword">throw</span> err;
            });
        };
    },</pre></div>
            </div>
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
                <p> A queue delays the execution of functions till the return value of previous execution is resolved. This is
 different from a sequence where, the actual promises are invoked immediately and only the resolution is delayed.</p>
<p> A queue can be used when multiple executions have to happen only one after the other (eg, updating the same
 records or autosave in a UI form)</p>
<p> This is detailed in the below examples:</p>
<pre><code class="lang-javascript">
 <span class="hljs-keyword">var</span> queue = lockable.queue();
 queue(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
     <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.delay(<span class="hljs-number">50</span>);
 }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
     <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>);
 });
 queue(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
     <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.delay(<span class="hljs-number">20</span>);
 }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
     <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>);
 });
 queue(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
     <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.delay(<span class="hljs-number">30</span>);
 }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
     <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>);
 });

 <span class="hljs-comment">// Output:</span>
 <span class="hljs-comment">// 1 (after 50 ms from start)</span>
 <span class="hljs-comment">// 2 (after 70 ms form start)</span>
 <span class="hljs-comment">// 3 (after 100 ms form start)</span>
</code></pre>

            </div><div class="content">
                <div class="highlight"><pre>    queue: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sequenceId, startCb, endCb</span>) </span>{
        <span class="hljs-keyword">if</span> (!sequenceId) {
            sequenceId = <span class="hljs-string">'sequence_'</span> + idGen;
            idGen = idGen + <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">var</span> promiseSequence = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">var</span> keyChain = <span class="hljs-keyword">this</span>.acquire(sequenceId);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
            callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    <span class="hljs-keyword">return</span>;
                };
            <span class="hljs-keyword">var</span> thisPromise;
            <span class="hljs-keyword">if</span> (!promiseSequence) {
                promiseSequence = <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">true</span>);</pre></div>
            </div>
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
                <p> when the sequence starts, we call the start callback</p>

            </div><div class="content">
                <div class="highlight"><pre>                <span class="hljs-keyword">if</span> (startCb) {
                    startCb();
                }
            }
            <span class="hljs-keyword">var</span> endSequenceIfRequired = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">forceEnd</span>) </span>{
                <span class="hljs-keyword">if</span> (forceEnd || promiseSequence === thisPromise) {</pre></div>
            </div>
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
                <p> when nothing new got added in the sequence, we end the sequence</p>

            </div><div class="content">
                <div class="highlight"><pre>                    <span class="hljs-keyword">if</span> (endCb) {
                        endCb();
                    }</pre></div>
            </div>
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
                <p> clear off the queue</p>

            </div><div class="content">
                <div class="highlight"><pre>                    promiseSequence = <span class="hljs-literal">null</span>;
                }
            };

            thisPromise = promiseSequence.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (!keyChain()) {
                    endSequenceIfRequired(<span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'concurrency failure'</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(callback.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
                    <span class="hljs-keyword">if</span> (!keyChain()) {
                        endSequenceIfRequired(<span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'concurrency failure'</span>);
                    }
                    endSequenceIfRequired();
                    <span class="hljs-keyword">return</span> data;
                }).catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                    endSequenceIfRequired(<span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">throw</span> err;
                });
            });
            promiseSequence = thisPromise;
            <span class="hljs-keyword">return</span> thisPromise;
        };
    }
};</pre></div>
            </div>
        </li>
        
    </ul>
</section>
</body>
</html>
